"use strict";var x=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var U=Object.prototype.hasOwnProperty;var i=(r,e)=>x(r,"name",{value:e,configurable:!0});var q=(r,e)=>{for(var t in e)x(r,t,{get:e[t],enumerable:!0})},G=(r,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of N(e))!U.call(r,n)&&n!==t&&x(r,n,{get:()=>e[n],enumerable:!(o=M(e,n))||o.enumerable});return r};var j=r=>G(x({},"__esModule",{value:!0}),r);var X={};q(X,{AwsStreamHandler:()=>k});module.exports=j(X);var nt=require("stream"),D=require("util");var P=require("http");var $=443,S=class extends P.IncomingMessage{static{i(this,"ServerlessRequest")}constructor({method:e,url:t,headers:o,body:n,remoteAddress:s}){super({encrypted:!0,readable:!1,remoteAddress:s,address:()=>({port:$}),end:u,destroy:u}),this.statusCode=200,this.statusMessage="OK",this.complete=!0,this.httpVersion="1.1",this.httpVersionMajor=1,this.httpVersionMinor=1,this.method=e,this.headers=o,this.body=n,this.url=t,this.ip=s,this._read=()=>{this.push(n),this.push(null)}}ip;body};var H=require("http");function v(r){if(Buffer.isBuffer(r))return r.toString("utf8");if(typeof r=="string")return r;if(r instanceof Uint8Array)return new TextDecoder().decode(r);throw new Error(`response.write() of unexpected type: ${typeof r}`)}i(v,"getString");var L=`\r
\r
`,Q=`0\r
\r
`,E=Symbol("Response body"),R=Symbol("Response headers");function C(r,e){if(Buffer.isBuffer(e)||typeof e=="string"||e instanceof Uint8Array)r[E].push(Buffer.from(e));else throw new Error(`response.write() of unexpected type: ${typeof e}`)}i(C,"addData");var T=class r extends H.ServerResponse{static{i(this,"ServerlessResponse")}constructor({method:e}){super({method:e}),this[E]=[],this[R]={},this.useChunkedEncodingByDefault=!1,this.chunkedEncoding=!1,this._header="";let t=1,o={_writableState:{},writable:!0,on:u,removeListener:u,destroy:u,cork:u,uncork:u,write:(n,s,a)=>{if(typeof s=="function"&&(a=s,s=null),this._header===""||this._wroteHeader)this.chunkedEncoding?t>0?t--:n!==Q&&(C(this,n),t=3):C(this,n);else{let d=v(n),p=d.indexOf(L);if(p!==-1){let l=d.slice(p+L.length);l&&!this.chunkedEncoding&&C(this,l),this._wroteHeader=!0}}typeof a=="function"&&a()}};this.assignSocket(o)}_header;_headers;_wroteHeader;[E];[R];get headers(){return this[R]}static from(e){let t=new r({method:e.method});return t.statusCode=e.statusCode||0,t[R]=e.headers,t[E]=e.body?[Buffer.from(e.body)]:[],t.end(),t}static body(e){return Buffer.concat(e[E])}static headers(e){let t=e.getHeaders();return Object.assign(t,e[R])}setHeader(e,t){this._wroteHeader?this[R][e]=t:super.setHeader(e,t)}writeHead(e,t,o){let n=typeof t=="string"?o:t,s=Array.isArray(n)?n:[n||{}];for(let a of s)for(let d in a)if(this.setHeader(d,a[d]),!this._wroteHeader)break;return this.callNativeWriteHead(e,t,o)}callNativeWriteHead(e,t,o){return super.writeHead(e,t,o)}};var B=require("http");var _=`0\r
\r
`,Y=`\r
\r
`,z=`\r
`,w=class extends B.ServerResponse{static{i(this,"ServerlessStreamResponse")}constructor({method:e,onReceiveHeaders:t,log:o}){super({method:e}),this.useChunkedEncodingByDefault=!0,this.chunkedEncoding=!0;let n=null,s=!0,a=0,d={_writableState:{},writable:!0,on:u,removeListener:u,destroy:u,cork:u,uncork:u,write:(p,l,f)=>{if(typeof l=="function"&&(f=l,l=null),o.debug("SERVERLESS_ADAPTER:RESPONSE_STREAM:DATA",()=>({data:Buffer.isBuffer(p)?p.toString("utf8"):p,encoding:l})),!s&&n){if(p===_)return n.end(f),!0;if(a>0)return a--,!0;n.write(p,f),a=3}else if(s){s=!1;let c=v(p),g=c.indexOf(z),h=+c.slice(0,g).split(" ")[1],m=c.indexOf(Y),y=c.slice(g+2,m),A=I(y);o.debug("SERVERLESS_ADAPTER:RESPONSE_STREAM:FRAMEWORK_HEADERS",()=>({headers:A})),a=1,n=t(h,A),c.substring(m+4)===_&&n.end()}return!0}};this.assignSocket(d)}};var b=class{static{i(this,"BaseHandler")}getAdapterByEventAndContext(e,t,o,n){let s=o.filter(a=>a.canHandle(e,t,n));if(s.length===0)throw new Error("SERVERLESS_ADAPTER: Couldn't find adapter to handle this event.");if(s.length>1)throw new Error(`SERVERLESS_ADAPTER: Two or more adapters was resolved by the event, the adapters are: ${o.map(a=>a.getAdapterName()).join(", ")}.`);return s[0]}getServerlessRequestResponseFromAdapterRequest(e){let t=new S({method:e.method,headers:e.headers,body:e.body,remoteAddress:e.remoteAddress,url:e.path}),o=new T({method:e.method});return[t,o]}};var O={context:null,event:null};function V({event:r,context:e}){O.event=r,O.context=e}i(V,"setCurrentInvoke");function W(r,e=",",t=!1){return Object.keys(r).reduce((o,n)=>{let s=t?n.toLowerCase():n,a=r[n];return Array.isArray(a)?o[s]=a.join(e):o[s]=(a??"")+"",o},{})}i(W,"getFlattenedHeadersMap");function I(r){if(!r)return{};let e={},t=r.trim().split(`
`);for(let o=0;o<t.length;o++){let n=t[o],s=n.indexOf(":"),a=n.slice(0,s).trim().toLowerCase(),d=n.slice(s+1).trim();typeof e[a]>"u"?e[a]=d:Array.isArray(e[a])?e[a].push(d):e[a]=[e[a],d]}return e}i(I,"parseHeaders");var u=i(()=>{},"NO_OP");var Be=Symbol("InternalLogger");var Me=require("stream");function K(r){return!!("readableEnded"in r&&r.readableEnded||"writableEnded"in r&&r.writableEnded)}i(K,"isStreamEnded");function F(r){return K(r)?Promise.resolve(r):new Promise((e,t)=>{let o=!1;function n(s){o||(o=!0,r.removeListener("error",n),r.removeListener("end",n),r.removeListener("finish",n),s?t(s):e(r))}i(n,"complete"),r.once("error",n),r.once("end",n),r.once("finish",n)})}i(F,"waitForStreamComplete");var k=class extends b{static{i(this,"AwsStreamHandler")}getHandler(e,t,o,n,s,a,d){return awslambda.streamifyResponse(async(p,l,f)=>{let c={response:l,context:f};this.onReceiveRequest(d,p,c,s,a);let g=this.getAdapterByEventAndContext(p,c,o,d);this.onResolveAdapter(d,g),V({event:p,context:f}),await this.forwardRequestToFramework(e,t,p,c,g,s,d)})}onReceiveRequest(e,t,o,n,s){e.debug("SERVERLESS_ADAPTER:PROXY",()=>({event:t,context:(0,D.inspect)(o,{depth:null}),binarySettings:n,respondWithErrors:s}))}onResolveAdapter(e,t){e.debug("SERVERLESS_ADAPTER:RESOLVED_ADAPTER_NAME: ",t.getAdapterName())}onResolveRequestValues(e,t){e.debug("SERVERLESS_ADAPTER:FORWARD_REQUEST_TO_FRAMEWORK:REQUEST_VALUES",()=>({requestValues:{...t,body:t.body?.toString()}}))}onForwardResponseAdapterResponse(e,t){e.debug("SERVERLESS_ADAPTER:FORWARD_RESPONSE:EVENT_SOURCE_RESPONSE",{successResponse:t})}async forwardRequestToFramework(e,t,o,n,s,a,d){let p=s.getRequest(o,n,d);this.onResolveRequestValues(d,p);let l=new S({method:p.method,headers:p.headers,body:p.body,remoteAddress:p.remoteAddress,url:p.path}),f=new w({method:p.method,onReceiveHeaders:(c,g)=>{let h=W(g),m={statusCode:c,headers:h},y=g["set-cookie"];y&&(m.cookies=Array.isArray(y)?y:[y],delete g["set-cookie"],delete h["set-cookie"]),this.onForwardResponseAdapterResponse(d,m);let A=awslambda.HttpResponseStream.from(n.response,m);return A.write(""),A},log:d});t.sendRequest(e,l,f),d.debug("SERVERLESS_ADAPTER:FORWARD_REQUEST_TO_FRAMEWORK:WAITING_STREAM_COMPLETE"),await F(f),d.debug("SERVERLESS_ADAPTER:FORWARD_REQUEST_TO_FRAMEWORK:STREAM_COMPLETE"),n.response.end()}};0&&(module.exports={AwsStreamHandler});
//# sourceMappingURL=index.cjs.map