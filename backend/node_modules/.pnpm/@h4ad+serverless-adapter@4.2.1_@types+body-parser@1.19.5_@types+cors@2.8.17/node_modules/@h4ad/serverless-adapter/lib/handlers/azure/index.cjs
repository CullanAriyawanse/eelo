"use strict";var F=Object.create;var m=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var N=Object.getPrototypeOf,W=Object.prototype.hasOwnProperty;var s=(t,e)=>m(t,"name",{value:e,configurable:!0});var U=(t,e)=>{for(var r in e)m(t,r,{get:e[r],enumerable:!0})},b=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of D(e))!W.call(t,o)&&o!==r&&m(t,o,{get:()=>e[o],enumerable:!(n=V(e,o))||n.enumerable});return t};var q=(t,e,r)=>(r=t!=null?F(N(t)):{},b(e||!t||!t.__esModule?m(r,"default",{value:t,enumerable:!0}):r,t)),M=t=>b(m({},"__esModule",{value:!0}),t);var K={};U(K,{AzureHandler:()=>x});module.exports=M(K);var w=require("http");var j=443,E=class extends w.IncomingMessage{static{s(this,"ServerlessRequest")}constructor({method:e,url:r,headers:n,body:o,remoteAddress:i}){super({encrypted:!0,readable:!1,remoteAddress:i,address:()=>({port:j}),end:c,destroy:c}),this.statusCode=200,this.statusMessage="OK",this.complete=!0,this.httpVersion="1.1",this.httpVersionMajor=1,this.httpVersionMinor=1,this.method=e,this.headers=n,this.body=o,this.url=r,this.ip=i,this._read=()=>{this.push(o),this.push(null)}}ip;body};var k=require("http");function A(t){if(Buffer.isBuffer(t))return t.toString("utf8");if(typeof t=="string")return t;if(t instanceof Uint8Array)return new TextDecoder().decode(t);throw new Error(`response.write() of unexpected type: ${typeof t}`)}s(A,"getString");var L=`\r
\r
`,$=`0\r
\r
`,T=Symbol("Response body"),R=Symbol("Response headers");function C(t,e){if(Buffer.isBuffer(e)||typeof e=="string"||e instanceof Uint8Array)t[T].push(Buffer.from(e));else throw new Error(`response.write() of unexpected type: ${typeof e}`)}s(C,"addData");var g=class t extends k.ServerResponse{static{s(this,"ServerlessResponse")}constructor({method:e}){super({method:e}),this[T]=[],this[R]={},this.useChunkedEncodingByDefault=!1,this.chunkedEncoding=!1,this._header="";let r=1,n={_writableState:{},writable:!0,on:c,removeListener:c,destroy:c,cork:c,uncork:c,write:(o,i,p)=>{if(typeof i=="function"&&(p=i,i=null),this._header===""||this._wroteHeader)this.chunkedEncoding?r>0?r--:o!==$&&(C(this,o),r=3):C(this,o);else{let a=A(o),d=a.indexOf(L);if(d!==-1){let u=a.slice(d+L.length);u&&!this.chunkedEncoding&&C(this,u),this._wroteHeader=!0}}typeof p=="function"&&p()}};this.assignSocket(n)}_header;_headers;_wroteHeader;[T];[R];get headers(){return this[R]}static from(e){let r=new t({method:e.method});return r.statusCode=e.statusCode||0,r[R]=e.headers,r[T]=e.body?[Buffer.from(e.body)]:[],r.end(),r}static body(e){return Buffer.concat(e[T])}static headers(e){let r=e.getHeaders();return Object.assign(r,e[R])}setHeader(e,r){this._wroteHeader?this[R][e]=r:super.setHeader(e,r)}writeHead(e,r,n){let o=typeof r=="string"?n:r,i=Array.isArray(o)?o:[o||{}];for(let p of i)for(let a in p)if(this.setHeader(a,p[a]),!this._wroteHeader)break;return this.callNativeWriteHead(e,r,n)}callNativeWriteHead(e,r,n){return super.writeHead(e,r,n)}};var Q=require("http");var S=class{static{s(this,"BaseHandler")}getAdapterByEventAndContext(e,r,n,o){let i=n.filter(p=>p.canHandle(e,r,o));if(i.length===0)throw new Error("SERVERLESS_ADAPTER: Couldn't find adapter to handle this event.");if(i.length>1)throw new Error(`SERVERLESS_ADAPTER: Two or more adapters was resolved by the event, the adapters are: ${n.map(p=>p.getAdapterName()).join(", ")}.`);return i[0]}getServerlessRequestResponseFromAdapterRequest(e){let r=new E({method:e.method,headers:e.headers,body:e.body,remoteAddress:e.remoteAddress,url:e.path}),n=new g({method:e.method});return[r,n]}};var B={context:null,event:null};function H({event:t,context:e}){B.event=t,B.context=e}s(H,"setCurrentInvoke");function Y(t,e){let r=t["content-encoding"];return r?(Array.isArray(r)||(r=r.split(",")),r.some(n=>e.includes(n.trim()))):!1}s(Y,"isContentEncodingBinary");function z(t){let e=t["content-type"],r=Array.isArray(e)?e[0]||"":e||"";if(!e)return"";let n=r.indexOf(";");return n===-1?r:r.slice(0,n)}s(z,"getContentType");function G(t,e){let r=z(t);return r?e.includes(r.trim()):!1}s(G,"isContentTypeBinary");function O(t,e){return"isBinary"in e?e.isBinary===!1?!1:e.isBinary(t):Y(t,e.contentEncodings)||G(t,e.contentTypes)}s(O,"isBinary");var c=s(()=>{},"NO_OP");var X=Symbol("InternalLogger");function I(t){return!!t[X]}s(I,"isInternalLogger");function _(t,e){return t===void 0?e:t}s(_,"getDefaultIfUndefined");var Ue=require("stream");function J(t){return!!("readableEnded"in t&&t.readableEnded||"writableEnded"in t&&t.writableEnded)}s(J,"isStreamEnded");function P(t){return J(t)?Promise.resolve(t):new Promise((e,r)=>{let n=!1;function o(i){n||(n=!0,t.removeListener("error",o),t.removeListener("end",o),t.removeListener("finish",o),i?r(i):e(t))}s(o,"complete"),t.once("error",o),t.once("end",o),t.once("finish",o)})}s(P,"waitForStreamComplete");var h=q(require("util"),1);var v=class extends S{static{s(this,"DefaultHandler")}getHandler(e,r,n,o,i,p,a){return(d,u,l)=>{this.onReceiveRequest(a,d,u,i,p);let f=this.getAdapterByEventAndContext(d,u,n,a);return this.onResolveAdapter(a,f),H({event:d,context:u}),o.createResolver({event:d,context:u,callback:l,log:a,respondWithErrors:p,adapter:f}).run(()=>this.forwardRequestToFramework(e,r,d,u,f,i,a))}}onReceiveRequest(e,r,n,o,i){e.debug("SERVERLESS_ADAPTER:PROXY",()=>({event:h.default.inspect(r,{depth:null}),context:h.default.inspect(n,{depth:null}),binarySettings:o,respondWithErrors:i}))}onResolveAdapter(e,r){e.debug("SERVERLESS_ADAPTER:RESOLVED_ADAPTER_NAME: ",r.getAdapterName())}onResolveRequestValues(e,r){e.debug("SERVERLESS_ADAPTER:FORWARD_REQUEST_TO_FRAMEWORK:REQUEST_VALUES",()=>({requestValues:{...r,body:r.body?.toString()}}))}onResolveForwardedResponseToFramework(e,r){e.debug("SERVERLESS_ADAPTER:FORWARD_REQUEST_TO_FRAMEWORK:RESPONSE",()=>({response:r}))}onForwardResponse(e,r,n,o,i){e.debug("SERVERLESS_ADAPTER:FORWARD_RESPONSE:EVENT_SOURCE_RESPONSE_PARAMS",()=>({statusCode:r,body:n,headers:o,isBase64Encoded:i}))}onForwardResponseAdapterResponse(e,r,n){e.debug("SERVERLESS_ADAPTER:FORWARD_RESPONSE:EVENT_SOURCE_RESPONSE",()=>({successResponse:h.default.inspect(r,{depth:null}),body:n}))}async forwardRequestToFramework(e,r,n,o,i,p,a){let d=i.getRequest(n,o,a);this.onResolveRequestValues(a,d);let[u,l]=this.getServerlessRequestResponseFromAdapterRequest(d);return r.sendRequest(e,u,l),await P(l),this.onResolveForwardedResponseToFramework(a,l),this.forwardResponse(n,l,i,p,a)}forwardResponse(e,r,n,o,i){let p=r.statusCode,a=g.headers(r),d=O(a,o),u=d?"base64":"utf8",l=g.body(r).toString(u),f=d?"[BASE64_ENCODED]":l;this.onForwardResponse(i,p,f,a,d);let y=n.getResponse({event:e,statusCode:p,body:l,headers:a,isBase64Encoded:d,response:r,log:i});return this.onForwardResponseAdapterResponse(i,y,f),y}};var x=class extends v{constructor(r){super();this.options=r}static{s(this,"AzureHandler")}getHandler(r,n,o,i,p,a,d){return(u,l)=>{let f=_(this.options?.useContextLogWhenInternalLogger,!0);I(d)&&f&&(d=this.createLoggerFromContext(u));let y=super.getHandler(r,n,o,i,p,a,d);return delete u.done,delete u.res,y(l,u,void 0)}}createLoggerFromContext(r){return{error:r.log.error,debug:r.log.verbose,verbose:r.log.verbose,info:r.log.info,warn:r.log.warn}}};0&&(module.exports={AzureHandler});
//# sourceMappingURL=index.cjs.map